---
title: "automatization_notebook_02"
output: word_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(DescTools)

```

# Чтение данных

В вашем варианте нужно использовать датасет food.

```{r}
data <- read_csv("C:/Users/Лиза/git/BioStat_2023/biostat_homework_092023/data/raw/food.csv")
data <- as_tibble(data)
```

# Выведите общее описание данных

```{r}
data %>% summary()

data %>% 
  select(!c(Category, Description, `Nutrient Data Bank Number`)) %>%
  psych::describe()
# или другой вариант, где мы выбираем только столбцы с колличественными данными
data %>% 
  select(where(is.numeric)) %>%
  psych::describe()
```

# Очистка данных

1) Уберите переменные, в которых пропущенных значений больше 20% или уберите субъектов со слишком большим количеством пропущенных значений. Или совместите оба варианта. Напишите обоснование, почему вы выбрали тот или иной вариант:

```{r}
sum(!complete.cases(data))
# в данных нет пропущенных значений   
```


**Обоснование**: 

2) Переименуйте переменные в человекочитаемый вид (что делать с пробелами в названиях?);

Для работы с переменными содержащие пробелы можно использовать ординарные кавычки `Nutrient Data Bank Number`
Или заменить пробел на точку или нижнее подчеркиваниее

```{r}
data <- data %>%
  rename(`Nutrient_Data_Bank_Number` = `Nutrient Data Bank Number`)
```
Уберем тавтологию, например, `Data.Vitamins.Vitamin K`  заменим на `Data.Vitamin K`

```{r}
data <- data %>%
  rename_with(function(x) x %>% stringi::stri_replace_all_regex(c("Vitamins."), c(""), vectorize_all = FALSE))
```
Аналогично
```{r}
data <- data %>%
  rename_with(function(x) x %>% 
                stringi::stri_replace_all_regex(c("Data.", "Fat.", "Major Minerals."), c("", "", ""), vectorize_all = FALSE))
```

Заменим пробелы 
```{r}
data <- data %>%
  rename_with(function(x) x %>% 
                stringi::stri_replace_all_regex(" ", "_", vectorize_all = FALSE))
```



3) В соответствии с описанием данных приведите переменные к нужному типу (numeric или factor);

```{r}
data <- data %>% 
  mutate(across(c(Category, Description, Nutrient_Bank_Number), ~ as.factor(.x)))
```


4) Отсортируйте данные по углеводам по убыванию;

```{r}
data <- data %>%
  arrange(desc(Carbohydrate))
head(data)
```


5) Сохраните в файл outliers.csv субъектов, которые являются выбросами (например, по правилу трёх сигм) — это необязательное задание со звёздочкой;

```{r}

outliers <- data %>% 
  mutate(across(where(is.numeric), function(x) if_else(x > 3*sd(x), x, NA)))


outliers <- outliers %>% 
  select(Nutrient_Bank_Number, where(is.numeric)) %>% 
  pivot_longer(!Nutrient_Bank_Number)

outliers <- outliers %>%
  drop_na(value)

write_csv(outliers, "C:/Users/Лиза/git/BioStat_2023/biostat_homework_092023/data/outliers.csv")
```


6) Отфильтруйте датасет так, чтобы остались только Rice и Cookie (переменная Category и есть группирующая);

```{r}
data %>% 
  filter(Category == c("Rice", "Cookie"))
```


7) Присвойте получившийся датасет переменной "cleaned_data".

```{r}

cleaned_data <- data %>% 
  filter(Category == c("Rice", "Cookie"))

```

# Сколько осталось переменных?

```{r}
cleaned_data %>%
  ncol()

# Осталось 38 переменных
```

# Сколько осталось случаев?

```{r}
cleaned_data %>%
  nrow()

# Осталось 123 случая

```

# Есть ли в данных идентичные строки?

```{r}
count_str_all <- cleaned_data %>%
  nrow()
count_str_unique <- cleaned_data %>% 
  distinct(Nutrient_Bank_Number, .keep_all = TRUE) %>%
  nrow()
count_str_all != count_str_unique
# В данных нет идентичных строк
```

# Сколько всего переменных с пропущенными значениями в данных и сколько пропущенных точек в каждой такой переменной?

```{r}
sum(!complete.cases(data))
# в данных нет пропущенных значений


```

# Описательные статистики

## Количественные переменные

1) Рассчитайте для всех количественных переменных для каждой группы (Category):

1.1) Количество значений;
```{r}
# Количество заполненных значений
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) sum(complete.cases(x))))
```
```{r}
# Немного другой вариант - количество субъектов (считаются и заполненые значения и NA)
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) length(x)))
```


1.2) Количество пропущенных значений;
```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) sum(!complete.cases(x))))
```
```{r}
# Или 

cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) sum(is.na(x))))
```


1.3) Среднее;
```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) mean(x)))
```

1.4) Медиану;
```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) median(x)))
```


1.5) Стандартное отклонение;
```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) sd(x)))

```


1.6) 25% квантиль и 75% квантиль;

```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) quantile(x, 0.25)))

cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) quantile(x, 0.75)))
```

1.7) Интерквартильный размах;

```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) IQR(x)))
```


1.8) Минимум;

```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) min(x)))
```


1.9) Максимум;

```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) max(x)))
```


1.10) 95% ДИ для среднего - задание со звёздочкой.

```{r}
cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), function(x) MeanCI(x)))
```

```{r}
statistics <- list(
      `Количество субъектов` = ~length(.x) %>% as.character(),
      `Количество (есть данные)` = ~sum(!is.na(.x)) %>% as.character(),
      `Нет данных` = ~sum(is.na(.x)) %>% as.character(),
      `Ср. знач.` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", mean(.x, na.rm = TRUE) %>% round(2) %>% as.character()),
      `Станд. отклон.` = ~ifelse(sum(!is.na(.x)) < 3, "Н/П*", sd(.x, na.rm = TRUE) %>% round(2) %>% as.character()),
      `95% ДИ для среднего` = ~sd(.x, na.rm = TRUE) %>% round(2) %>% as.character(),
      `мин. - макс.` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", paste0(min(.x, na.rm = TRUE) %>% round(2), " - ", max(.x, na.rm = TRUE) %>% round(2))),
      `Медиана` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", median(.x, na.rm = TRUE) %>% round(2) %>% as.character()),
      `Q1 - Q3` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", paste0(quantile(.x, 0.25, na.rm = TRUE) %>% round(2), " - ", quantile(.x, 0.75, na.rm = TRUE) %>% round(2))),
      `Межквартильный размах` = ~ifelse(sum(!is.na(.x)) == 0, "Н/П*", IQR(.x, na.rm = TRUE)%>% round(2) %>% as.character())
)

cleaned_data %>% 
  select(Category, where(is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(is.numeric), statistics)) %>%
  pivot_longer(!Category) %>%
  separate(name, into = "Статистика", sep = "__") %>%
  rename(`Значение` = value)
```

## Категориальные переменные

1) Рассчитайте для всех категориальных переменных для каждой группы (Category):

1.1) Абсолютное количество;
```{r}

cleaned_data %>% 
  select(Category, where(!is.numeric)) %>%
  group_by(Category) %>%
  summarize(across(where(!is.numeric), function(x) length(x))) 
```


1.2) Относительное количество внутри группы;

1.3) 95% ДИ для доли внутри группы - задание со звёздочкой.

```{r}



```

# Визуализация

## Количественные переменные

1) Для каждой количественной переменной сделайте боксплоты по группам. Расположите их либо на отдельных рисунках, либо на одном, но читаемо;

2) Наложите на боксплоты beeplots - задание со звёздочкой.

3) Раскрасьте боксплоты с помощью библиотеки RColorBrewer.

```{r}



```

## Категориальные переменные

1) Сделайте подходящие визуализации категориальных переменных. Обоснуйте, почему выбрали именно этот тип.

```{r}



```


# Статистические оценки

## Проверка на нормальность

1) Оцените каждую переменную на соответствие нормальному распределению с помощью теста Шапиро-Уилка. Какие из переменных являются нормальными и как как вы это поняли?

```{r}



```

2) Постройте для каждой количественной переменной QQ-плот. Отличаются ли выводы от теста Шапиро-Уилка? Какой метод вы бы предпочли и почему?

```{r}



```

3) Ниже напишите, какие ещё методы проверки на нормальность вы знаете и какие у них есть ограничения.

**Напишите текст здесь**


## Сравнение групп

1) Сравните группы (переменная **Category**) по каждой переменной (как количественной, так и категориальной). Для каждой переменной выберите нужный критерий и кратко обоснуйте его выбор в комментариях.

```{r}



```

# Далее идут **необязательные** дополнительные задания, которые могут принести вам дополнительные баллы в том числе в случае ошибок в предыдущих

## Корреляционный анализ

1) Создайте корреляционную матрицу с визуализацией и поправкой на множественные сравнения. Объясните, когда лучше использовать корреляционные матрицы и в чём минусы и плюсы корреляционных исследований.

```{r}



```

## Моделирование

1) Постройте регрессионную модель для переменной **Category**. Опишите процесс построения

```{r}



```




